<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas | MetaMapa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <style>
        body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial; margin:16px; background:#0b0b0c; color:#e9e9ea;}
        .grid{display:grid; gap:16px;}
        .grid-3{grid-template-columns: repeat(3, 1fr);}
        .card{background:#151516; border:1px solid #2a2a2d; border-radius:16px; padding:16px; box-shadow:0 1px 8px rgba(0,0,0,.35);}
        .muted{color:#a6a6ab; font-size:14px}
        .kpi{font-size:28px; font-weight:700}
        header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
        a.btn{background:#2b6ef5; color:white; text-decoration:none; padding:10px 14px; border-radius:10px; font-weight:600}
        .charts{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px;}
        @media (max-width: 1100px){ .charts{grid-template-columns: 1fr; } .grid-3{grid-template-columns: 1fr;} }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
    <div>
        <h2 style="margin:0">Dashboard de Estadísticas</h2>
        <div class="muted">Actualiza cada 60 s automáticamente</div>
    </div>
    <div>
        <a class="btn" href="/estadistica/export/summary.csv">Exportar CSV</a>
    </div>
</header>

<section class="grid grid-3">
    <div class="card">
        <div class="muted">Categoría más reportada</div>
        <div class="kpi" id="kpiTopCategory" th:text="${snapshot.topCategory}">—</div>
        <div class="muted">Reportes: <span id="kpiTopCategoryCount" th:text="${snapshot.topCategoryCount}">—</span></div>
    </div>

    <div class="card">
        <div class="muted">Total de hechos</div>
        <div class="kpi" id="kpiTotalFacts" th:text="${snapshot.totalFacts}">—</div>
    </div>

    <div class="card">
        <div class="muted">Solicitudes de eliminación marcadas como spam</div>
        <div class="kpi" id="kpiSpam" th:text="${snapshot.spamRequests}">—</div>
    </div>
</section>

<section class="charts" style="margin-top:16px">
    <div class="card">
        <div class="muted">Top 5 categorías</div>
        <canvas id="chartCategories" height="220"></canvas>
    </div>
    <div class="card">
        <div class="muted">Distribución horaria (categoría top)</div>
        <canvas id="chartHourly" height="220"></canvas>
    </div>
    <div class="card">
        <div class="muted">Top 10 provincias</div>
        <canvas id="chartProvinces" height="220"></canvas>
    </div>
</section>

<script>
    // Cargamos snapshot del servidor renderizado para primer paint
    const SNAPSHOT = /*[[${snapshot}]]*/ {};
    // Thymeleaf fallback si no hay JS inlining:
    const snapshotSafe = /*[[${snapshot}]]*/ {"topCategory":/*[[${snapshot.topCategory}]]*/"", "topCategoryCount":/*[[${snapshot.topCategoryCount}]]*/0, "totalFacts":/*[[${snapshot.totalFacts}]]*/0, "spamRequests":/*[[${snapshot.spamRequests}]]*/0, "topCategories":/*[[${snapshot.topCategories}]]*/[], "hourlyHistogramTopCategory":/*[[${snapshot.hourlyHistogramTopCategory}]]*/[], "topProvinces":/*[[${snapshot.topProvinces}]]*/[]};

    let chartCategories, chartHourly, chartProvinces;

    function $(id){ return document.getElementById(id); }

    function initCharts(data){
        const catLabels = (data.topCategories||[]).map(x=>x.name);
        const catData   = (data.topCategories||[]).map(x=>x.count);

        const hourLabels = Array.from({length:24}, (_,i)=> (i.toString().padStart(2,'0')) + ":00");
        const hourData = data.hourlyHistogramTopCategory||[];

        const provLabels = (data.topProvinces||[]).map(x=>x.name);
        const provData   = (data.topProvinces||[]).map(x=>x.count);

        if (!chartCategories){
            chartCategories = new Chart($('chartCategories').getContext('2d'), {
                type: 'doughnut',
                data: { labels: catLabels, datasets: [{ data: catData }] },
                options: { plugins: { legend:{position:'bottom'} } }
            });
        } else {
            chartCategories.data.labels = catLabels;
            chartCategories.data.datasets[0].data = catData;
            chartCategories.update();
        }

        if (!chartHourly){
            chartHourly = new Chart($('chartHourly').getContext('2d'), {
                type: 'bar',
                data: { labels: hourLabels, datasets: [{ label:'Hechos', data: hourData }] },
                options: { scales:{ y:{ beginAtZero:true } } }
            });
        } else {
            chartHourly.data.datasets[0].data = hourData;
            chartHourly.update();
        }

        if (!chartProvinces){
            chartProvinces = new Chart($('chartProvinces').getContext('2d'), {
                type: 'bar',
                data: { labels: provLabels, datasets: [{ label:'Hechos', data: provData }] },
                options: {
                    indexAxis: 'y',
                    scales:{ x:{ beginAtZero:true } }
                }
            });
        } else {
            chartProvinces.data.labels = provLabels;
            chartProvinces.data.datasets[0].data = provData;
            chartProvinces.update();
        }
    }

    function paintKpis(data){
        $('kpiTopCategory').textContent = data.topCategory ?? '—';
        $('kpiTopCategoryCount').textContent = data.topCategoryCount ?? '—';
        $('kpiTotalFacts').textContent = data.totalFacts ?? '—';
        $('kpiSpam').textContent = data.spamRequests ?? '—';
    }

    async function refresh(){
        try{
            const res = await fetch('/estadistica/api/summary', { cache:'no-store' });
            if(res.status === 204) return; // sin datos
            const data = await res.json();
            paintKpis(data);
            initCharts(data);
        }catch(e){ console.error('Refresh error', e); }
    }

    // Primer render con snapshot del servidor
    paintKpis(snapshotSafe);
    initCharts(snapshotSafe);

    // Auto-refresh cada 60s
    setInterval(refresh, 60000);
</script>
</body>
</html>
